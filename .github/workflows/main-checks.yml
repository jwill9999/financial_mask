name: Main Branch Checks

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  main-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.11.1'

    - name: Install dependencies
      run: npm ci

    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable

    - name: Setup Chrome for testing
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        sudo chown root /opt/hostedtoolcache/setup-chrome/chromium/stable/x64/chrome-sandbox
        sudo chmod 4755 /opt/hostedtoolcache/setup-chrome/chromium/stable/x64/chrome-sandbox

    - name: Build
      run: npm run build:all

    - name: Lint
      run: npm run lint:all
      
    - name: Run unit tests with coverage
      run: npm run test:all
      env:
        CHROME_BIN: /opt/hostedtoolcache/setup-chrome/chromium/stable/x64/chrome

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        slug: jwill9999/financial_mask
        files: ./coverage/angular-app/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true
      
    - name: Run e2e tests
      run: |
        npx nx build angular-app --configuration=production
        npx nx serve angular-app --configuration=production --port 4201 &
        sleep 10  # Wait for app to start
        npx nx affected --target=e2e --configuration=ci --browser=chrome --headless=true --watch=false --base-url=http://localhost:4201
        pkill -f "nx serve" || true
      env:
        CHROME_BIN: /opt/hostedtoolcache/setup-chrome/chromium/stable/x64/chrome

    - name: Upload E2E Artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-artifacts
        path: |
          cypress/videos
          cypress/screenshots
