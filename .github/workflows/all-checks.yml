name: "All Checks"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Run build
        uses: ./.github/actions/run-check
        id: build
        with:
          name: 'Build'
          command: 'npm run build'
      - name: Run tests
        uses: ./.github/actions/run-check
        id: tests
        with:
          name: 'Tests'
          command: 'npm run test:ci'
          continue-on-error: true
      - name: Run E2E tests
        uses: ./.github/actions/run-check
        id: e2e
        with:
          name: 'E2E Tests'
          command: 'npm run e2e:ci'
          continue-on-error: true
      - name: Run accessibility checks
        uses: ./.github/actions/run-check
        id: a11y
        with:
          name: 'Accessibility'
          command: 'npm run lint:a11y'
          continue-on-error: true
      - name: Run code quality checks
        uses: ./.github/actions/run-check
        id: code-quality
        with:
          name: 'Code Quality'
          command: 'npm run lint && npm run format:check'
          continue-on-error: true
      - name: Update README badges
        uses: ./.github/actions/run-check
        id: update-badges
        with:
          name: 'Update Badges'
          command: |
            sed -i "s/build-.*-brightgreen/build-${{ steps.build.outputs.status }}-${{ steps.build.outputs.color }}/g" README.md
            sed -i "s/tests-.*-brightgreen/tests-${{ steps.tests.outputs.status }}-${{ steps.tests.outputs.color }}/g" README.md
            sed -i "s/e2e-.*-brightgreen/e2e-${{ steps.e2e.outputs.status }}-${{ steps.e2e.outputs.color }}/g" README.md
            sed -i "s/accessibility-.*-brightgreen/accessibility-${{ steps.a11y.outputs.status }}-${{ steps.a11y.outputs.color }}/g" README.md
            sed -i "s/code-quality-.*-brightgreen/code-quality-${{ steps.code-quality.outputs.status }}-${{ steps.code-quality.outputs.color }}/g" README.md
      - name: Create PR comment
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/run-check
        id: pr-comment
        with:
          name: 'PR Comment'
          command: |
            echo "## Build Status" > comment.md
            echo "- Build: ${{ steps.build.outputs.status }}" >> comment.md
            echo "- Tests: ${{ steps.tests.outputs.status }}" >> comment.md
            echo "- E2E: ${{ steps.e2e.outputs.status }}" >> comment.md
            echo "- Accessibility: ${{ steps.a11y.outputs.status }}" >> comment.md
            echo "- Code Quality: ${{ steps.code-quality.outputs.status }}" >> comment.md
            gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md 